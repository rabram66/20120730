<% content_for :javascripts do %>
  <script type="text/javascript" src="http://maps.googleapis.com/maps/api/js?sensor=true"></script>  
  <script type="text/javascript">
    var directionDisplay;
    var directionsService = new google.maps.DirectionsService();
    var map;
    var marker;
    var bussiness_address;
    function initialize() {
      directionsDisplay = new google.maps.DirectionsRenderer();
      var latlng = new google.maps.LatLng(<%= @location.geo_code.first %> , <%= @location.geo_code.last %>);
      bussiness_address = latlng;
      var myOptions = {
        zoom:10,
        mapTypeId: google.maps.MapTypeId.ROADMAP,
        center: bussiness_address
      }
      map = new google.maps.Map(document.getElementById("map_canvas"), myOptions);
      directionsDisplay.setMap(map);
      directionsDisplay.setPanel(document.getElementById('directions-panel'));
            
      //marker = new google.maps.Marker({position: bussiness_address, map: map, title: 'Click me' });
  
      var contentString  = "<b><%= raw @location.name %></b> <%= rating_info %> \n";


  <% if @last_tweet %> 
      contentString += "<table style='width:400px;margin-bottom:0px !important;'><tr><td style='padding:0px;width:20px;'><img src='/images/twitter-logo.jpg'/></td>";
      contentString += "<td><%= format_tweet_for_map(@last_tweet) %>&nbsp;&nbsp;&nbsp;&nbsp;<a href=\"http://twitter.com/<%= @last_tweet.screen_name %>/status/<%= @last_tweet.tweet_id %>\" target=\"_blank\">follow</a></td></tr></table>";
  <% end %>

  <% if @last_post %> 
      contentString += "<table style='width:400px;margin-bottom:0px !important;'><tr><td style='padding:0px;width:20px;'><img src='/images/facebook-logo.png'/></td>"
      contentString += "<td><%= format_wall_post_for_map(@last_post).html_safe %>&nbsp;&nbsp;&nbsp;&nbsp;<a target='_blank' href='http://www.facebook.com/<%= @location.facebook_page_id %>'>visit page</a></td></tr></table>";
  <% end %>
    
    var infowindow = new google.maps.InfoWindow({ content: contentString, position: latlng});
        
    infowindow.open(map, marker); 
      
      
    var request = {
      origin: "<%= cookies[:address].gsub("&", ",") unless cookies[:address].blank? %>",
      destination: bussiness_address,
      travelMode: google.maps.DirectionsTravelMode.WALKING
    };
    directionsService.route(request, function(response, status) {
      if (status == google.maps.DirectionsStatus.OK) {
        directionsDisplay.setDirections(response);
      }
    });
      
    //directionsDisplay.setMap(map);
  }
  
  function calcRoute() {
    marker.setMap(null);
    var start = document.getElementById('start').value;
      
    var end = document.getElementById('end').value;
    if (end == "") {
      end = bussiness_address;
    }
    var request = {
      origin: start,
      destination: end,
      travelMode: google.maps.DirectionsTravelMode.WALKING
    };
    directionsService.route(request, function(response, status) {
      if (status == google.maps.DirectionsStatus.OK) {
        directionsDisplay.setDirections(response);
      }
    });
  }    
  google.maps.event.addDomListener(window, 'load', initialize);
  </script>
<% end %>

<div>  
  <input type="hidden" id="end" value="<%= @origin_address %>" />  
  <input type="hidden" id="start" value="<%= cookies[:address].gsub("&", ",") unless cookies[:address].blank? %>"/>  
  <input type="hidden" id="route" />
</div>  

<div id="detail">  
  <br/><br/>
  <div class="back_index"><%= link_to 'Back', locations_path %></div>

  <div id="map_canvas"></div>
  <div id="people_saying">
    <div>
      <a href="#" id="direction_id">Directions</a>
    </div>
    <div id="directions-panel">
      <%= @origin_address %>
    </div>
    <table id="metions_id" class="tweet_result">
      <tr>
        <td colspan="2"><h3>What people are saying about 
              <%= @location.name %>
          </h3></td>
      </tr>
      <% unless @user_saying.blank? %>
        <% @user_saying.each do |user_say| %>
          <tr>
            <td>
              <a href="http://twitter.com/<%= user_say.screen_name %>" target="_blank">
                <img src="<%= user_say.profile_image_url %>" />
              </a>
            </td>
            <td>              
              <%= user_say.text.html_safe %>
              <a href="http://twitter.com/<%= user_say.screen_name %>/status/<%= user_say.tweet_id %>" target="_blank">
                follow
              </a><br/>
              <%= time_ago_in_words user_say.created_at %> ago
            </td>
          </tr>          
        <% end %>   
        <tr>
          <td colspan="2"><a href="http://twitter.com/search?q=%40<%= @location.twitter_name %>" target="_blank">more tweets</a></td>
        </tr>
      <% else %>
        <tr><td colspan="2">No tweets</td></tr>
      <% end %>
    </table>    
  </div>
 <div><!--/* OpenX Javascript Tag v2.8.6-rc2 */-->

<!--/*
  * The backup image section of this tag has been generated for use on a
  * non-SSL page. If this tag is to be placed on an SSL page, change the
  *   'http://d1.openx.org/...'
  * to
  *   'https://d1.openx.org/...'
  *
  * This noscript section of this tag only shows image banners. There
  * is no width or height in these banners, so if you want these tags to
  * allocate space for the ad before it shows, you will need to add this
  * information to the <img> tag.
  *
  * If you do not want to deal with the intricities of the noscript
  * section, delete the tag (from <noscript>... to </noscript>). On
  * average, the noscript tag is called from less than 1% of internet
  * users.
  */-->

<script type='text/javascript'><!--//<![CDATA[
   var m3_u = (location.protocol=='https:'?'https://d1.openx.org/ajs.php':'http://d1.openx.org/ajs.php');
   var m3_r = Math.floor(Math.random()*99999999999);
   if (!document.MAX_used) document.MAX_used = ',';
   document.write ("<scr"+"ipt type='text/javascript' src='"+m3_u);
   document.write ("?zoneid=239053");
   document.write ('&amp;cb=' + m3_r);
   if (document.MAX_used != ',') document.write ("&amp;exclude=" + document.MAX_used);
   document.write (document.charset ? '&amp;charset='+document.charset : (document.characterSet ? '&amp;charset='+document.characterSet : ''));
   document.write ("&amp;loc=" + escape(window.location));
   if (document.referrer) document.write ("&amp;referer=" + escape(document.referrer));
   if (document.context) document.write ("&context=" + escape(document.context));
   if (document.mmm_fo) document.write ("&amp;mmm_fo=1");
   document.write ("'><\/scr"+"ipt>");
//]]>--></script><noscript><a href='http://d1.openx.org/ck.php?n=a912c611&amp;cb=4532' target='_blank'><img src='http://d1.openx.org/avw.php?zoneid=239053&amp;cb=4532&amp;n=a912c611' border='0' alt='' /></a></noscript>

 
 </div>
  <div style="float: left;"><% unless @advertise.blank? %>
      <%= image_tag @advertise.photo.url(:medium), :style => "margin: -200px 0 0 200px; position:relative" %>
    <% end %>
   
  </div>
  
  <br/><br/>
</div>
<script>
  $("#route").click();
</script>