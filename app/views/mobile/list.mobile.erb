<script type='text/javascript'>
var twitterNames = [
  <%= @locations.select{|l1| !l1.twitter_name.blank?}.map{|l2| "'#{l2.twitter_name}'"}.join(',') -%>
];

var fetchCount = 0;
var maxFetchCount = 3;

function recentTweetUpdate() {
  setTimeout(function() {
    checkStatus(function(data) {
      $.each(data, function(i,id) {
        if ($('li#'+id).length) $('li#'+id).addClass('recent_tweet');
      });
      if (fetchCount < maxFetchCount) recentTweetUpdate();
    });
  }, 5000);
}

function checkStatus(callback) {
  fetchCount++;
  $.post("/recent_tweeters", { 'n[]': twitterNames }, function(data) {
    callback(data);
  });
}    

$(function() {
  recentTweetUpdate();
});
</script>

<div data-role="header" data-id="category-selector" data-position="fixed" data-theme='a'>
  <div data-role="navbar">
    <ul id='category-selector'>
      <li class='home'><a href='/'><img src="/images/mobile/logo-trans.png"/></a></li>
      <li class='first'><a href="#">EAT</a></li>
      <li><a href="#">SHOP</a></li>
      <li><a href="#">RELAX</a></li>
    </ul>
  </div>
</div>
<div data-role='content'>
  <div id='event-and-deal-links'>
    <%= ( link_to "#{pluralize(@deals.length, 'Daily Deal')}", 
          mobile_deals_path(:lat => @geocode.first, :lng => @geocode.last), 
          :"data-role" => 'button') if @deals.count > 0 %>
    <%= ( link_to "#{pluralize(@events.length, 'Event')}",
          mobile_events_path(:lat => @geocode.first, :lng => @geocode.last), 
          :"data-role" => 'button') if @events.length > 0 %>
  </div>
  
  <ul id='locations-list' data-role="listview" data-theme='b'>
    <% for location in @locations -%>
      <% if Location === location -%>
        <li id='<%= location.twitter_name %>' class='<%= category_class_names(location) %> <%=location.recent_tweet? ? "recent_tweet" : "" %>' style='display:none'>
          <a href="<%=mobile_detail_path(location.reference) %>">
            <img src='/images/twitter-logo.jpg' class='ui-li-icon twitter-icon'/>
            <b><%= location.name %></b> - <%= number_with_precision(location.distance, :precision => 1) %> miles
          </a>
        </li>
      <% else -%>
        <li class='<%= category_class_names(location)%>' style='display:none'>
          <%= link_to "<b>#{location.name}</b> - #{number_with_precision(location.distance_from(@geocode), :precision => 1)} miles".html_safe, mobile_detail_path(location.reference) %>
        </li>
      <% end -%>
    <% end -%>
  </ul>
</div>