<%= render "script" %>

<script type='text/javascript'>
  var twitterNames = [
    <%= @locations.select{|l1| !l1.twitter_name.blank?}.map{|l2| "'#{l2.twitter_name}'"}.join(',') -%>
  ];

  var fetchCount = 0;
  var maxFetchCount = 3;

  function recentTweetUpdate() {
    setTimeout(function() {
      checkStatus(function(data) {
        $.each(data, function(i,name) {
          $('img.'+name).fadeIn();
        });
        if (fetchCount < maxFetchCount) recentTweetUpdate();
      });
    }, 5000);
  }

  function checkStatus(callback) {
    fetchCount++;
    $.post("/recent_tweeters", { 'n[]': twitterNames }, function(data) {
      callback(data);
    });
  }    

  $(function() {
    recentTweetUpdate();
  });
</script>
<div class="banner"><!--banner start-->
  <div class="banner_area">
    <form action="" method="get" id='place_search'>
      <label>Find a place to</label>
      <%= select_tag :types, options_for_select(LocationCategory.all.map{|lc| [lc.display_name, lc.name]}, params[:types]), :class => 'list_menu' %>
      <label>near</label>
      <%= text_field_tag :search, @search, :id => "searchTextField", :class => 'form_field' %>
      <%= submit_tag "", :name => nil, :class => 'button' %>
    </form>
  </div>
</div><!--banner end-->

<div class="content nopadd"><!--content start-->
  <div class="content_left padd"><!--content_left start-->
    <% @locations.each do |location| %>
      <div class="block">
        <p>
          <% if Location === location && can?(:update, location) %>
            <%= link_to 'Edit', edit_location_path(location), :class => 'inline' %>
          <% end %>
          <a href="<%= url_for_location_details(location) %>">
            <%= location.name %><strong><%= " - #{location.address}" unless location.address.blank? %></strong>
            <% if location.tweets? -%>
              <%= image_tag "twitter.jpg" %>
            <% end -%>
            <% if location.twitter_deal? -%>
              <span class='twitter-deal'>$</span>
            <% end -%>
            <% if Location === location && !location.twitter_name.blank? -%>
              <%= image_tag "flame.png", :class => "#{location.twitter_name} recent_tweet", 
                                         :style => location.recent_tweet? ? "display:inline" : "display:none" -%>
            <% end -%>
            <% if location.deals? -%>
              <%= image_tag "yipit-logo-small.jpg" %>
            <% end -%>
            <span class='distance-from'><%= number_with_precision(location.distance_from(@coordinates), :precision => 1) %> miles</span>
          </a>
        </p>
      </div>
    <% end -%>
  </div><!--content_left end-->

  <div class="sidebar"><!--sidebar start-->
    <div class="sidebar_top">
      <div id="maps"></div>
    </div>
      <% unless @events.count == 0 %>
        <div class='sidebar_block sidebar_txt'>
          <h3>Nearby Events</h3>
          <% unless @events.happening_now.count == 0 %>
            <h4>Happening Today</h4>
            <% @events.happening_now.each do |event| %>
              <p>
                <%= (Event === event) ? link_to(content_tag(:strong, event.name), event) : link_to(event.name, event_path(event.id)) %>
              </p>
            <% end -%>
          <% end -%>
          <% unless @events.coming_soon.count == 0 %>
            <h4>Coming Soon</h4>
            <% @events.coming_soon.each do |event| %>
              <p>
                <%= (Event === event) ? link_to(content_tag(:strong, event.name), event) : link_to(event.name, event_path(event.id)) %>
              </p>
            <% end -%>
          <% end -%>
        </div>
      <% end -%>
      <% unless @deals.length == 0 %>
        <div class='sidebar_block sidebar_txt'>
          <h3>Nearby Deals <span class='powered-by'>powered by <%= image_tag "yipit-logo-small.jpg"%></span></h3>
          <% @deals.each do |deal| %>
            <p>
              <%= link_to deal.title, deal.url, :target => :blank %>
            </p>
          <% end -%>
        </div>
      <% end -%>
  </div><!--sidebar end-->

  <div class="clear"></div>

</div><!--content end-->